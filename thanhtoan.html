<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh to√°n | PK Store</title>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>

  <body class="body-thanhtoan">
    <div class="container checkout-container my-5">
      <h3 class="text-center mb-4 text-uppercase fw-bold text-dark">
        Thanh To√°n ƒê∆°n H√†ng
      </h3>

      <!-- ƒê·ªãa ch·ªâ giao h√†ng -->
      <div class="mb-4">
        <h5 class="section-title">Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <input type="text" class="form-control" id="fullname" placeholder="H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n" required />
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" required />
          </div>
          <div class="col-12">
            <input type="text" class="form-control" id="address" placeholder="ƒê·ªãa ch·ªâ c·ª• th·ªÉ (S·ªë nh√†, ƒë∆∞·ªùng...)" required />
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" id="city" placeholder="T·ªânh/Th√†nh ph·ªë" required />
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" id="district" placeholder="Qu·∫≠n/Huy·ªán" required />
          </div>
        </div>
      </div>

      <!-- Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn -->
      <div class="mb-4">
        <h5 class="section-title">Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn</h5>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="shipping" id="fast" value="30000" checked />
          <label class="form-check-label" for="fast">Giao h√†ng nhanh (2-3 ng√†y) - 30.000ƒë</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="shipping" id="save" value="20000" />
          <label class="form-check-label" for="save">Giao h√†ng ti·∫øt ki·ªám (4-6 ng√†y) - 20.000ƒë</label>
        </div>
      </div>

      <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
      <div class="mb-4">
        <h5 class="section-title">Ph∆∞∆°ng th·ª©c thanh to√°n</h5>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="payment" id="cod" checked />
          <label class="form-check-label" for="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="payment" id="bank" />
          <label class="form-check-label" for="bank">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="payment" id="momo" />
          <label class="form-check-label" for="momo">V√≠ MoMo / ZaloPay / VNPay</label>
        </div>
      </div>

      <!-- Ki·ªÉm tra l·∫°i ƒë∆°n h√†ng -->
      <div class="mb-4">
        <h5 class="section-title">Ki·ªÉm tra l·∫°i ƒë∆°n h√†ng</h5>
        <table class="table align-middle" id="orderTable">
          <thead>
            <tr>
              <th>S·∫£n ph·∫©m</th>
              <th class="text-center">S·ªë l∆∞·ª£ng</th>
              <th class="text-end">Th√†nh ti·ªÅn</th>
            </tr>
          </thead>
          <tbody id="orderBody">
            <tr>
              <td colspan="3" class="text-center text-muted">ƒêang t·∫£i...</td>
            </tr>
          </tbody>
        </table>

        <div class="order-summary mt-3">
          <div class="d-flex justify-content-between">
            <span>T·∫°m t√≠nh:</span>
            <strong id="subtotal">0 ƒë</strong>
          </div>
          <div class="d-flex justify-content-between">
            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
            <strong id="shippingFee">30.000 ƒë</strong>
          </div>
          <hr />
          <div class="d-flex justify-content-between fs-5 mt-2">
            <span>T·ªïng c·ªông:</span>
            <strong class="text-danger" id="totalPrice">0 ƒë</strong>
          </div>
        </div>
      </div>

      <!-- N√∫t x√°c nh·∫≠n -->
      <div class="text-center">
        <button class="btn btn-danger px-5 fw-bold" onclick="confirmOrder()">X√°c nh·∫≠n ƒë·∫∑t h√†ng</button>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:3000/api/books";
      const orderBody = document.getElementById("orderBody");
      const subtotalEl = document.getElementById("subtotal");
      const totalPriceEl = document.getElementById("totalPrice");
      const shippingFeeEl = document.getElementById("shippingFee");
      let subtotal = 0;

      // L·∫•y danh s√°ch gi·ªè h√†ng
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");

      if (cart.length === 0) {
        orderBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">Gi·ªè h√†ng tr·ªëng!</td></tr>`;
      } else {
        renderOrder();
      }

      // üß© Hi·ªÉn th·ªã s·∫£n ph·∫©m trong b·∫£ng thanh to√°n
      async function renderOrder() {
        subtotal = 0;
        let html = "";

        for (const item of cart) {
          try {
            const res = await fetch(`${API_BASE}/${item.id}`);
            const product = await res.json();

            const discount = product.discount || 0;
            const finalPrice = product.price * (1 - discount / 100);
            const total = finalPrice * item.quantity;
            subtotal += total;

            html += `
              <tr>
                <td>${product.title}</td>
                <td class="text-center">${item.quantity}</td>
                <td class="text-end">${total.toLocaleString()} ƒë</td>
              </tr>
            `;
          } catch (e) {
            console.error(e);
          }
        }

        orderBody.innerHTML = html;
        subtotalEl.textContent = subtotal.toLocaleString() + " ƒë";
        updateTotal();
      }

      // üöö T√≠nh t·ªïng c·ªông (bao g·ªìm ph√≠ ship)
      function updateTotal() {
        const shipping = document.querySelector('input[name="shipping"]:checked').value;
        const total = subtotal + parseInt(shipping);
        shippingFeeEl.textContent = parseInt(shipping).toLocaleString() + " ƒë";
        totalPriceEl.textContent = total.toLocaleString() + " ƒë";
      }

      document.querySelectorAll('input[name="shipping"]').forEach((radio) =>
        radio.addEventListener("change", updateTotal)
      );

      // ‚úÖ X√°c nh·∫≠n ƒë·∫∑t h√†ng
      function confirmOrder() {
        const name = document.getElementById("fullname").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const address = document.getElementById("address").value.trim();

        if (!name || !phone || !address) {
          alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!");
          return;
        }

        alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua s·∫Øm t·∫°i PK Store ‚ù§Ô∏è");

        // X√≥a gi·ªè h√†ng sau khi ƒë·∫∑t
        localStorage.removeItem("cart");

        // Quay v·ªÅ trang ch·ªß
        window.location.href = "index.html";
      }
    </script>
  </body>
</html>
